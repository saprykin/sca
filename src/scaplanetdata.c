/*
 * Copyright (C) 2011 Alexander Saprykin <xelfium@gmail.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301  USA.
 */

/**
 * According to VSOP87 planet theory, each planet's position can be calculated
 * using long period terms (similar to Fourie transforms). L corresponds to
 * heliocentric longitude, B to heliocentric latitude and R for distance to the
 * Sun. To get each of parameter, you should perform following actions:
 * 	1. Each line in data array consists of three values: A, B, C.
 * 	2. T is millenniums in JDE since J2000 epoch.
 * 	3. Find appropriate L0 variable by formulae
 *		L0 = sum (A * cos (B + C * T)) for each line in L0 data array.
 * 	4. Find L1..Ln variables as described above (see size parameters to determine
 *	   how much variables are available, i.e. for Earth there are 6 for L, 2 for
 *	   B and 5 for R, use 0.0 if variable is not available). 
 *	5. Finaly, L = L0 + L1 * T + L2 * T^2 + L3 * T^3 + L4 * T^4 + L5 * T^5.
 *	6. Resulting variable L measured in radians.
 *	7. Perform the same calculations for B and R.
 */

#include <scaplanetdata.h>
#include <scajulianday.h>

#define SCA_PLANET_DATA_MAX	6

/** Private structure for planet data. */
typedef struct _SCAPlanetDataPrivate {
	unsigned int	L_size[SCA_PLANET_DATA_MAX];	/**< Sizes of L-series terms.	*/
	unsigned int	B_size[SCA_PLANET_DATA_MAX];	/**< Sizes of B-series terms.	*/
	unsigned int	R_size[SCA_PLANET_DATA_MAX];	/**< Sizes of R-series terms.	*/
	double		data[][3];			/**< Terms data.		*/
} SCAPlanetDataPrivate;

const static SCAPlanetDataPrivate earth_data = {
/* L, B and R series sizes */
{64,	34,	20,	7,	3,	1},
{5,	2,	0,	0,	0,	0},
{40,	10,	6,	2,	1,	0},
{
/* L0 data */
{1.75347046,		0.0,		0.0		},
{0.03341656,		4.6692568,	6283.0758500	},
{0.00034894,		4.62610,	12566.15170	},
{0.00003497,		2.7441,		5753.3849	},
{0.00003418,		2.8289,		3.5231		},
{0.00003136,		3.6277,		77713.7715	},
{0.00002676,		4.4181,		7860.4194	},
{0.00002343,		6.1352,		3930.2097	},
{0.00001324,		0.7425,		11506.7698	},
{0.00001273,		2.0371,		529.6910	},
{0.00001199,		1.1096,		1577.3435	},
{0.00000990,		5.233,		5884.927	},
{0.00000902,		2.045,		26.298		},
{0.00000857,		3.508,		398.149		},
{0.00000780,		1.179,		5223.694	},
{0.00000753,		2.533,		5507.553	},
{0.00000505,		4.583,		18849.228	},
{0.00000492,		4.205,		775.523		},
{0.00000357,		2.920,		0.067		},
{0.00000317,		5.849,		11790.629	},
{0.00000284,		1.899,		796.298		},
{0.00000271,		0.315,		10977.079	},
{0.00000243,		0.345,		5486.778	},
{0.00000206,		4.806,		2544.314	},
{0.00000205,		1.869,		5573.143	},
{0.00000202,		2.458,		6069.777	},
{0.00000156,		0.833,		213.299		},
{0.00000132,		3.411,		2942.463	},
{0.00000126,		1.083,		20.775		},
{0.00000115,		0.645,		0.980		},
{0.00000103,		0.636,		4694.003	},
{0.00000102,		0.976,		15720.839	},
{0.00000102,		4.267,		7.114		},
{0.00000099,		6.21,		2146.17		},
{0.00000098,		0.68,		155.42		},
{0.00000086,		5.98,		161000.69	},
{0.00000085,		1.30,		6275.96		},
{0.00000085,		3.67,		71430.70	},
{0.00000080,		1.81,		17260.15	},
{0.00000079,		3.04,		12036.46	},
{0.00000075,		1.76,		5088.63		},
{0.00000074,		3.50,		3154.69		},
{0.00000074,		4.68,		801.82		},
{0.00000070,		0.83,		9437.76		},
{0.00000062,		3.98,		8827.39		},
{0.00000061,		1.82,		7084.90		},
{0.00000057,		2.78,		6286.60		},
{0.00000056,		4.39,		14143.50	},
{0.00000056,		3.47,		6279.55		},
{0.00000052,		0.19,		12139.55	},
{0.00000052,		1.33,		1748.02		},
{0.00000051,		0.28,		5856.48		},
{0.00000049,		0.49,		1194.45		},
{0.00000041,		5.37,		8429.24		},
{0.00000041,		2.40,		19651.05	},
{0.00000039,		6.17,		10447.39	},
{0.00000037,		6.04,		10213.29	},
{0.00000037,		2.57,		1059.38		},
{0.00000036,		1.71,		2352.87		},
{0.00000036,		1.78,		6812.77		},
{0.00000033,		0.59,		17789.85	},
{0.00000030,		0.44,		83996.85	},
{0.00000030,		2.74,		1349.87		},
{0.00000025,		3.16,		4690.48		},

/* L1 data */
{6283.31966747,		0.0,		0.0		},
{0.00206059,		2.678235,	6283.075850	},
{0.00004303,		2.6351,		12566.1517	},
{0.00000425,		1.590,		3.523		},
{0.00000119,		5.796,		26.298		},
{0.00000109,		2.966,		1577.344	},
{0.00000093,		2.59,		18849.23	},
{0.00000072,		1.14,		529.69		},
{0.00000068,		1.87,		398.15		},
{0.00000067,		4.41,		5507.55		},
{0.00000059,		2.89,		5223.69		},
{0.00000056,		2.17,		155.42		},
{0.00000045,		0.40,		796.30		},
{0.00000036,		0.47,		775.52		},
{0.00000029,		2.65,		7.11		},
{0.00000021,		5.34,		0.98		},
{0.00000019,		1.85,		5486.78		},
{0.00000019,		4.97,		213.30		},
{0.00000017,		2.99,		6275.96		},
{0.00000016,		0.03,		2544.31		},
{0.00000016,		1.43,		2146.17		},
{0.00000015,		1.21,		10977.08	},
{0.00000012,		2.83,		1748.02		},
{0.00000012,		3.26,		5088.63		},
{0.00000012,		5.27,		1194.45		},
{0.00000012,		2.08,		4694.00		},
{0.00000011,		0.77,		553.57		},
{0.00000010,		1.30,		6286.60		},
{0.00000010,		4.24,		1349.87		},
{0.00000009,		2.70,		242.73		},
{0.00000009,		5.64,		951.72		},
{0.00000008,		5.30,		2352.87		},
{0.00000006,		2.65,		9437.76		},
{0.00000006,		4.67,		4690.48		},

/* L2 data */
{0.00052919,		0.0,		0.0		},
{0.00008720,		1.0721,		6283.0758	},
{0.00000309,		0.867,		12566.152	},
{0.00000027,		0.05,		3.52		},
{0.00000016,		5.19,		26.30		},
{0.00000016,		3.68,		155.42		},
{0.00000010,		0.76,		18849.23	},
{0.00000009,		2.06,		77713.77	},
{0.00000007,		0.83,		775.52		},
{0.00000005,		4.66,		1577.34		},
{0.00000004,		1.03,		7.11		},
{0.00000004,		3.44,		5573.14		},
{0.00000003,		5.14,		796.30		},
{0.00000003,		6.05,		5507.55		},
{0.00000003,		1.19,		242.73		},
{0.00000003,		6.12,		529.69		},
{0.00000003,		0.31,		398.15		},
{0.00000003,		2.28,		553.57		},
{0.00000002,		4.38,		5223.69		},
{0.00000002,		3.75,		0.98		},

/* L3 data */
{0.00000289,		5.844,		6283.076	},
{0.00000035,		0.0,		0.0		},
{0.00000017,		5.49,		12566.15	},
{0.00000003,		5.20,		155.42		},
{0.00000001,		4.72,		3.52		},
{0.00000001,		5.30,		18849.23	},
{0.00000001,		5.97,		242.73		},

/* L4 data */
{0.00000114,		3.142,		0.0		},
{0.00000008,		4.13,		6283.08		},
{0.00000001,		3.84,		12566.15	},

/* L5 data */
{0.00000001,		3.14,		0.0		},

/* B0 data */
{0.00000280,		3.199,		0.0		},
{0.00000102,		5.422,		5507.533	},
{0.00000080,		3.88,		5223.69		},
{0.00000044,		3.70,		2352.87		},
{0.00000032,		4.0,		1577.34		},

/* B1 data */
{0.00000009,		3.90,		5507.55		},
{0.00000006,		1.73,		5223.69		},

/* R0 data */
{1.00013989,		0.0,		0.0		},
{0.01670700,		3.0984635,	6283.0758500	},
{0.00013956,		3.05525,	12556.15170	},
{0.00003084,		5.1985,		77713.7715	},
{0.00001628,		1.1739,		5753.3849	},
{0.00001576,		2.8469,		7860.4194	},
{0.00000925,		5.453,		11506.770	},
{0.00000542,		4.564,		3930.210	},
{0.00000472,		3.661,		5884.927	},
{0.00000346,		0.964,		5507.553	},
{0.00000329,		5.900,		5223.694	},
{0.00000307,		0.299,		5573.143	},
{0.00000243,		4.273,		11790.629	},
{0.00000212,		5.847,		1577.344	},
{0.00000186,		5.022,		10977.079	},
{0.00000175,		3.012,		18849.228	},
{0.00000110,		5.055,		5486.778	},
{0.00000098,		0.89,		6069.78		},
{0.00000086,		5.69,		15720.84	},
{0.00000086,		1.27,		161000.69	},
{0.00000065,		0.27,		17260.15	},
{0.00000063,		0.92,		529.69		},
{0.00000057,		2.01,		83996.85	},
{0.00000056,		5.24,		71430.70	},
{0.00000049,		3.25,		2544.31		},
{0.00000047,		2.58,		775.52		},
{0.00000045,		5.54,		9437.76		},
{0.00000043,		6.01,		6275.96		},
{0.00000039,		5.36,		4694.00		},
{0.00000038,		2.39,		8827.39		},
{0.00000037,		0.83,		19651.05	},
{0.00000037,		4.90,		12139.55	},
{0.00000036,		1.67,		12036.46	},
{0.00000035,		1.84,		2942.46		},
{0.00000033,		0.24,		7084.90		},
{0.00000032,		0.18,		5088.63		},
{0.00000032,		1.78,		398.15		},
{0.00000028,		1.21,		6286.60		},
{0.00000028,		1.90,		6279.55		},
{0.00000026,		4.59,		10447.39	},

/* R1 data */
{0.00103019,		1.107490,	6283.075850	},
{0.00001721,		1.0644,		12566.1517	},
{0.00000702,		3.142,		0.0		},
{0.00000032,		1.02,		18849.23	},
{0.00000031,		2.84,		5507.55		},
{0.00000025,		1.32,		5223.69		},
{0.00000018,		1.42,		1577.34		},
{0.00000010,		5.91,		10977.08	},
{0.00000009,		1.42,		6275.96		},
{0.00000009,		0.27,		5486.78		},

/* R2 data */
{0.00004359,		5.7846,		6283.0758	},
{0.00000124,		5.579,		12566.152	},
{0.00000012,		3.14,		0.0		},
{0.00000009,		3.63,		77713.77	},
{0.00000006,		1.87,		5573.14		},
{0.00000003,		5.47,		18849.23	},

/* R3 data */
{0.00000145,		4.273,		6283.076	},
{0.00000007,		3.92,		12566.15	},

/* R4 data */
{0.00000004,		2.56,		6283.08		}
}
};

int
sca_planet_data_get (SCAPlanet planet, double jd, SCAAngle *lon, SCAAngle *lat, double *dst)
{
	const SCAPlanetDataPrivate	*pd = NULL;
	unsigned int			cnt, i, j;
	double				L[SCA_PLANET_DATA_MAX];
	double				B[SCA_PLANET_DATA_MAX];
	double				R[SCA_PLANET_DATA_MAX];
	double				L_res, B_res;
	double				t;

	if (planet < SCA_PLANET_MERCURY || planet > SCA_PLANET_NEPTUNE)
		return -1;

	if (jd < 0)
		return -1;

	switch (planet) {
	case SCA_PLANET_EARTH:
		pd = &earth_data;
		break;
	default:
		break;
	}

	if (pd == NULL)
		return -1;

	t = sca_jd_get_millenia_2000 (jd);

	for (i = 0; i < SCA_PLANET_DATA_MAX; ++i)
		L[i] = B[i] = R[i] = 0.0;

	cnt = 0;
	for (i = 0; i < SCA_PLANET_DATA_MAX && pd->L_size[i] != 0; ++i) {
		for (j = 0; j < pd->L_size[i]; ++j, ++cnt)
			L[i] += pd->data[cnt][0] * cos (pd->data[cnt][1] + pd->data[cnt][2] * t);
	}
	
	for (i = 0; i < SCA_PLANET_DATA_MAX && pd->B_size[i] != 0; ++i) {
		for (j = 0; j < pd->B_size[i]; ++j, ++cnt)
			B[i] += pd->data[cnt][0] * cos (pd->data[cnt][1] + pd->data[cnt][2] * t);
	}

	for (i = 0; i < SCA_PLANET_DATA_MAX && pd->R_size[i] != 0; ++i) {
		for (j = 0; j < pd->R_size[i]; ++j, ++cnt)
			R[i] += pd->data[cnt][0] * cos (pd->data[cnt][1] + pd->data[cnt][2] * t);
	}

	if (lon != NULL) {
		L_res	= (L[0]
			   + L[1] * t
			   + L[2] * t * t
			   + L[3] * t * t * t
			   + L[4] * t * t * t * t
			   + L[5] * t * t * t * t * t);

		*lon	= sca_angle_from_radians (L_res);
		sca_angle_reduce (lon);
	}

	if (lat != NULL) {
		B_res	= (B[0]
			   + B[1] * t
			   + B[2] * t * t
			   + B[3] * t * t * t
			   + B[4] * t * t * t * t
			   + B[5] * t * t * t * t * t);

		*lat	= sca_angle_from_radians (B_res);
		sca_angle_reduce (lat);
	}

	if (dst != NULL)
		*dst	= (R[0]
			   + R[1] * t
			   + R[2] * t * t
			   + R[3] * t * t * t
			   + R[4] * t * t * t * t
			   + R[5] * t * t * t * t * t);

	return 0;
}


